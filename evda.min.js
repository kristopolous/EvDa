function EvDa(){function s(a){a.ix=++t;a.refList=[];return o[a.ix]=a}function l(a){return _.extend(a.child,a.parent)}function m(a){a.refList&&i(a.refList,function(d){var b=d[0],d=d[1],f=_.indexOf(g[b][d],a);g[b][d].splice(f,1)});delete o[a.ix]}function p(a){var d={};a.scope=a.scope?[a.scope]:[];if(!a.meta)a.meta=[];i(q(c),function(b){d[b]=function(){c[b].apply(this,a.scope.concat(n.call(arguments),a.meta));return d}});return d}var e={},i=_.each,q=_.keys,n=Array.prototype.slice,b={},t=0,o={},g={},
j={},h={},c={};h.Stage=function(a,d,u,f){var c=g[f.stage][a],e;if(!c)return f.result;e=c.length;i(c,function(c,e){f.result[e]=c(d,{meta:u,oldValue:f.oldValue,currentValue:b[a],key:a,deregister:function(){c.oneShot=!0}})});for(ix=0;ix<e;ix++)c[ix].oneShot&&m(c[ix])};h.Invoke=function(a,d,c){var f=b[a],e={};d!==void 0&&(b[a]=d);h.Stage(a,d,c,{result:e,stage:"invoke",oldValue:f});h.Stage(a,d,c,{result:e,stage:"after",oldValue:f});delete j[a];return e};h.Test=function(a,d,c){function f(b){arguments.length==
0&&(b=!0);r+=b;k+=!b;if(r+k==e)if(k)j[a]=!1;else return h.Invoke(a,d,c)}var e=g.test[a].length,r=0,k=0;i(g.test[a],function(e){e(d,{meta:c,oldValue:b[a],callback:f,key:a,deregister:function(){m(e)}})})};h.Run=function(a,d,b){var c={};if(j[a])return c;j[a]=!0;return c=g.test[a]?h.Test(a,d,b):h.Invoke(a,d,b)};c={ifChanged:function(a,d){return!(a in b)?c.run(a,d):b[a]!==d?c.run(a,d):!1},popandpush:function(a,d){is.array(b[a])||(b[a]=[]);b[a].pop();b[a].push(d);b[a].current=d;return c.run(a,b[a])},pop:function(a){if(!is.array(b[a]))return!1;
b[a].pop();b[a].current=b[a].length>0?b[a][b[a].length-1]:void 0;return c.run(a,b[a])},append:function(a,d){is.array(b[a])||(b[a]=[]);b[a].push(d);b[a].current=d;return c.run(a,b[a])},setHash:function(a,d){return c.run(a,_.extend(!0,d,b[a]))},onSet:function(a,b){return c.invoke(a,b).handle},decr:function(a){return a in b&&typeof b[a]=="number"?c.run(a,b[a]-1):c.run(a,0)},incr:function(a){return a in b&&typeof b[a]=="number"?c.run(a,b[a]+1):c.run(a,1)},run:function(a,b,c){var f={};_.isString(a)&&(a=
[a]);i(a,function(a){f[a]=h.Run(a,b,c)});return f},notNull:function(a,d){if(a in b&&b[a]!==null)d(b[a]);else return c.onSet.once(a,d)},meta:function(a){return p({meta:a})},deregister:m};c.push=c.append;c.share=c.meta;c.onSet.once=function(a,b){var e=c.onSet(a,b);e.oneShot=!0;return e};i("test,invoke,after".split(","),function(a){g[a]={};c[a]=function(b,e){e&&(e=s(e),_.isString(b)&&(b=[b]),i(b,function(b){g[a][b]||(g[a][b]=[]);g[a][b].push(e);e.refList.push([a,b])}));return l({child:{handle:e},parent:c})}});
e.Event=function(a,b){if(arguments.length==0)return g;var c=p({scope:a});if(_.isFunction(b))c.invoke(b);else if(arguments.length>1)c.run(b);else if(arguments[0].constructor==Object){var c={},f;for(f in arguments[0])c[f]=e.Event(f,arguments[0][f])}return c};e.Data=function(a,d){var e=n.call(arguments),f={},g=[];if(arguments.length===0)return b;if(typeof a==="object"){for(var h in a)f[h]=arguments.callee.apply(this,[h,a[h]]);return f}if(arguments.length==1){if(a.search(/[\*\?]/)!=-1){var k=RegExp(a,
"ig"),f=[];i(q(b),function(a){a.match(k)&&f.push(a)});return f}if(_.isArray(b[a]))try{_.isFunction(b[a].push)}catch(j){console.log("woops, caught a bad error for "+a),b[a]=n.call(b[a])}return b[a]}this.constructor==Array&&(g=this);return c.run.apply(this,e.concat(g))};l({child:e.Event,parent:c});l({child:e.Data,parent:c});c.set=e.Data.set=e.get=e.set=e.Data;return e};
