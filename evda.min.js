function EvDa(){function r(a){a.ix=++s;a.refList=[];return n[a.ix]=a}function o(a){return _.extend(a.child,a.parent)}function l(a){a.refList&&_.each(a.refList,function(d){var b=d[0],d=d[1],e=_.indexOf(f[b][d],a);f[b][d].splice(e,1)});delete n[a.ix]}function p(a){var d={};a.scope=a.scope?[a.scope]:[];if(!a.meta)a.meta=[];_.each(_.keys(c),function(b){d[b]=function(){c[b].apply(this,a.scope.concat(m.call(arguments),a.meta));return d}});return d}var i={},b={},s=0,n={},f={},k={},g={},m=Array.prototype.slice,
c={};g.Stage=function(a,d,j,e){var c=f[e.stage][a],g;if(!c)return e.result;g=c.length;for(var h=0;h<g;h++)e.result[c[h]]=c[h](d,{meta:j,oldValue:e.oldValue,currentValue:b[a],key:a,deregister:function(){c[h].oneShot=!0}});for(h=0;h<g;h++)c[h].oneShot&&l(c[h])};g.Invoke=function(a,d,c){var e=b[a],f={};d!==void 0&&(b[a]=d);g.Stage(a,d,c,{result:f,stage:"invoke",oldValue:e});g.Stage(a,d,c,{result:f,stage:"after",oldValue:e});delete k[a];return f};g.Test=function(a,d,c){function e(b){arguments.length==
0&&(b=!0);q+=b;h+=!b;if(q+h==i)if(h)k[a]=!1;else return g.Invoke(a,d,c)}var i=f.test[a].length,q=0,h=0;_.each(f.test[a],function(f){f(d,{meta:c,oldValue:b[a],callback:e,key:a,deregister:function(){l(f)}})})};g.Run=function(a,d,b){var c={};if(k[a])return c;k[a]=!0;return c=f.test[a]?g.Test(a,d,b):g.Invoke(a,d,b)};c={ifChanged:function(a,d){return!(a in b)?c.run(a,d):b[a]!==d?c.run(a,d):!1},popandpush:function(a,d){is.array(b[a])||(b[a]=[]);b[a].pop();b[a].push(d);b[a].current=d;return c.run(a,b[a])},
pop:function(a){if(!is.array(b[a]))return!1;b[a].pop();b[a].current=b[a].length>0?b[a][b[a].length-1]:void 0;return c.run(a,b[a])},append:function(a,d){is.array(b[a])||(b[a]=[]);b[a].push(d);b[a].current=d;return c.run(a,b[a])},setHash:function(a,d){return c.run(a,_.extend(!0,d,b[a]))},onSet:function(a,b){return c.invoke(a,b).handle},decr:function(a){return a in b&&typeof b[a]=="number"?c.run(a,b[a]-1):c.run(a,0)},incr:function(a){return a in b&&typeof b[a]=="number"?c.run(a,b[a]+1):c.run(a,1)},run:function(a,
b,c){var e={};_.isString(a)&&(a=[a]);_.each(a,function(a){e[a]=g.Run(a,b,c)});return e},notNull:function(a,d){if(a in b&&b[a]!==null)d(b[a]);else return c.onSet.once(a,d)},meta:function(a){return p({meta:a})},deregister:l};c.push=c.append;c.share=c.meta;c.onSet.once=function(a,b){var j=c.onSet(a,b);j.oneShot=!0;return j};_.each("test,invoke,after".split(","),function(a){f[a]={};c[a]=function(b,j){j&&(j=r(j),_.isString(b)&&(b=[b]),_.each(b,function(b){f[a][b]||(f[a][b]=[]);f[a][b].push(j);j.refList.push([a,
b])}));return o({child:{handle:j},parent:c})}});i.Event=function(a,b){if(arguments.length==0)return f;var c=p({scope:a});if(_.isFunction(b))c.invoke(b);else if(arguments.length>1)c.run(b);else if(arguments[0].constructor==Object){var c={},e;for(e in arguments[0])c[e]=i.Event(e,arguments[0][e])}return c};i.Data=function(a,d){var f=m.call(arguments),e={},g=[];if(arguments.length===0)return b;if(typeof a==="object"){for(var i in a)e[i]=arguments.callee.apply(this,[i,a[i]]);return e}if(arguments.length==
1){if(_.isArray(b[a]))try{_.isFunction(b[a].push)}catch(h){console.log("woops, caught a bad error for "+a),b[a]=m.call(b[a])}return b[a]}this.constructor==Array&&(g=this);return c.run.apply(this,f.concat(g))};_.each("Event,Data".split(","),function(a){o({child:i[a],parent:c})});c.set=i.Data;i.Data.set=i.Data;return i};
