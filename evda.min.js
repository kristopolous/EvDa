function EvDa(){function s(a){a.ix=++t;a.refList=[];return o[a.ix]=a}function l(a){return _.extend(a.child,a.parent)}function m(a){a.refList&&j(a.refList,function(d){var b=d[0],d=d[1],f=_.indexOf(h[b][d],a);h[b][d].splice(f,1)});delete o[a.ix]}function p(a){var d={};a.scope=a.scope?[a.scope]:[];if(!a.meta)a.meta=[];j(q(c),function(b){d[b]=function(){c[b].apply(this,a.scope.concat(n.call(arguments),a.meta));return d}});return d}var e={},j=_.each,q=_.keys,n=Array.prototype.slice,b={},t=0,o={},h={},
k={},i={},c={};i.Stage=function(a,d,u,f){var c=h[f.stage][a],e;if(!c)return f.result;e=c.length;for(var g=0;g<e;g++)f.result[c[g]]=c[g](d,{meta:u,oldValue:f.oldValue,currentValue:b[a],key:a,deregister:function(){c[g].oneShot=!0}});for(g=0;g<e;g++)c[g].oneShot&&m(c[g])};i.Invoke=function(a,d,c){var f=b[a],e={};d!==void 0&&(b[a]=d);i.Stage(a,d,c,{result:e,stage:"invoke",oldValue:f});i.Stage(a,d,c,{result:e,stage:"after",oldValue:f});delete k[a];return e};i.Test=function(a,d,c){function f(b){arguments.length==
0&&(b=!0);r+=b;g+=!b;if(r+g==e)if(g)k[a]=!1;else return i.Invoke(a,d,c)}var e=h.test[a].length,r=0,g=0;j(h.test[a],function(e){e(d,{meta:c,oldValue:b[a],callback:f,key:a,deregister:function(){m(e)}})})};i.Run=function(a,d,b){var c={};if(k[a])return c;k[a]=!0;return c=h.test[a]?i.Test(a,d,b):i.Invoke(a,d,b)};c={ifChanged:function(a,d){return!(a in b)?c.run(a,d):b[a]!==d?c.run(a,d):!1},popandpush:function(a,d){is.array(b[a])||(b[a]=[]);b[a].pop();b[a].push(d);b[a].current=d;return c.run(a,b[a])},pop:function(a){if(!is.array(b[a]))return!1;
b[a].pop();b[a].current=b[a].length>0?b[a][b[a].length-1]:void 0;return c.run(a,b[a])},append:function(a,d){is.array(b[a])||(b[a]=[]);b[a].push(d);b[a].current=d;return c.run(a,b[a])},setHash:function(a,d){return c.run(a,_.extend(!0,d,b[a]))},onSet:function(a,b){return c.invoke(a,b).handle},decr:function(a){return a in b&&typeof b[a]=="number"?c.run(a,b[a]-1):c.run(a,0)},incr:function(a){return a in b&&typeof b[a]=="number"?c.run(a,b[a]+1):c.run(a,1)},run:function(a,b,c){var f={};_.isString(a)&&(a=
[a]);j(a,function(a){f[a]=i.Run(a,b,c)});return f},notNull:function(a,d){if(a in b&&b[a]!==null)d(b[a]);else return c.onSet.once(a,d)},meta:function(a){return p({meta:a})},deregister:m};c.push=c.append;c.share=c.meta;c.onSet.once=function(a,b){var e=c.onSet(a,b);e.oneShot=!0;return e};j("test,invoke,after".split(","),function(a){h[a]={};c[a]=function(b,e){e&&(e=s(e),_.isString(b)&&(b=[b]),j(b,function(b){h[a][b]||(h[a][b]=[]);h[a][b].push(e);e.refList.push([a,b])}));return l({child:{handle:e},parent:c})}});
e.Event=function(a,b){if(arguments.length==0)return h;var c=p({scope:a});if(_.isFunction(b))c.invoke(b);else if(arguments.length>1)c.run(b);else if(arguments[0].constructor==Object){var c={},f;for(f in arguments[0])c[f]=e.Event(f,arguments[0][f])}return c};e.Data=function(a,d){var e=n.call(arguments),f={},h=[];if(arguments.length===0)return b;if(typeof a==="object"){for(var i in a)f[i]=arguments.callee.apply(this,[i,a[i]]);return f}if(arguments.length==1){if(a.search(/[\*\?]/)!=-1){var g=RegExp(a,
"ig"),f=[];j(q(b),function(a){a.match(g)&&f.push(a)});return f}if(_.isArray(b[a]))try{_.isFunction(b[a].push)}catch(k){console.log("woops, caught a bad error for "+a),b[a]=n.call(b[a])}return b[a]}this.constructor==Array&&(h=this);return c.run.apply(this,e.concat(h))};l({child:e.Event,parent:c});l({child:e.Data,parent:c});c.set=e.Data;c.get=e.Data;e.Data.set=e.Data;return e};
