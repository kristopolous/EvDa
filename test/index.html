<!doctype html>
<html>
<head>
  <title>EvDa test suite</title>
  <link rel=stylesheet href=qunit.css>
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src=underscore.js > </script>
  <script src=../evda.js > </script>
  <script src=qunit.js > </script>
</head>
<body>
  <h1 id=qunit-header>EvDa test suite</h1>
  <h2 id="qunit-banner"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <h2 id="qunit-userAgent"></h2>
  <ol id="qunit-tests"></ol>
</body>
<script>
$(function(){
  
module("Initialization");
  test("No arguments", function(){
    var ev = EvDa();
    equal(typeof ev, 'function', "Initialized");
  });

  test("K/V pair", function(){
    var ev = EvDa({key: 'value'});
    equal(ev.db.key, 'value', "Initialized");
  });

module("Basic");
  test("Set a key", function(){
    var ev = EvDa();
    ev('key', 'value');
    equal(ev.db.key, 'value', "Initialized");
  });

  test("Set a key, object style", function(){
    expect(1);
    var ev = EvDa();
    ev({key: 'value'});
    equal(ev.db.key, 'value', "Initialized");
  });

  test("Set 3 keys, object style", function(){
    expect(6);
    var ev = EvDa();

    ev({key0: function(){
        equal(_.keys(ev.db).length, 3, '3 Keys exist before first callback is run');
      }
    });

    ev({
      key2: function(){
        equal(ev.db.key1, 1, 'Keys appear to have the correct value');
      },
      key1: function(){
        equal(_.keys(ev.db).length, 3, 'All 3 callbacks are run');
      }
    });

    ev({
      key0: 'value0',
      key1: 1,
      key2: true
    });

    equal(ev.db.key0, 'value0', "Initialized key0");
    equal(ev.db.key1, 1, "Initialized key1");
    equal(ev.db.key2, true, "Initialized key2");
  });

  test("Get a key", function(){
    var ev = EvDa();
    ev('key', 'value');
    equal(ev('key'), 'value', "Initialized");
  });

  test("Unset a key", function(){
    var ev = EvDa();
    ev('key', 'value');
    equal(ev.db.key, 'value', "Initialized");
    ev.unset('key')
    equal(_.keys(ev.db).join(''), '', "Removed");
  });

module("OO binding");
  test("Set a key", function() {
    expect(3);
    function m() {
      var ev = EvDa.call(this);

      this.callback = function() {
        equal(1, 1, "binding done");
      }

      ev.isset('key', function() {
        equal(this.value, 123, "binding done");
        equal(typeof(self.value), 'undefined', "right scope");
        this.callback();
      });

      this.value = 123;

      ev.set('key');
    }
    new m();
  });

module("sniff");
  test("register object callbacks, set from object, make sure they all are hit", function(){
    expect(3);
    var ev = EvDa();

    ev.sniff();
    ev({
      b: function(value) { equal(value, 'b', 'object (b) Callback triggered'); },
      a: function(value) { equal(value, 'a', 'object (a) Callback triggered'); },
      c: function(value) { equal(value, 'c', 'object (c) Callback triggered'); },

      // Shouldn't hit
      d: function(value) { equal(value, 'd', 'object (d) Callback triggered'); }
    });

    ev({
      a: 'a',
      b: 'b',
      c: 'c',

      // Has nothing associated with it
      e: 'e'
    });
  });

module("Callbacks on set");
  test("register a callback, arglist style", function(){
    expect(1);
    var ev = EvDa();

    ev('key', function(value) {
      equal(value, 'value', 'Callback triggered');
    });

    ev('key', 'value');
  });

  test("register a callback, object style", function(){
    expect(1);
    var ev = EvDa();

    ev({keyobj: function(value) {
      equal(value, 'value', 'Callback triggered');
    }});

    ev('keyobj', 'value');
  });

  test("register multiple callbacks, make sure they all are hit", function(){
    expect(6);
    var ev = EvDa();

    ev('keyobj', function(value) {
      equal(value, 'value', 'arglist Callback triggered');
    });

    ev({keyobj: function(value) {
      equal(value, 'value', 'object (1) Callback triggered');
    }});

    ev({
      nothere: function(value) {},
      keyobj: function(value) {
        equal(value, 'value', 'object (2) Callback triggered');
      }
    });

    ev('keyobj', 'value');
    ev('keyobj', 'value');
  });

  test("register array callbacks, make sure they all are hit", function(){
    expect(3);
    var ev = EvDa();

    ev(['a', 'b', 'c', 'd'], function(value, meta) {
      equal(meta.key, value, 'object Callback triggered');
    });

    ev({
      a: 'a',
      b: 'b',
      c: 'c',

      // Has nothing associated with it
      e: 'e'
    });
  });

  test("register object callbacks, set from object, make sure they all are hit", function(){
    expect(3);
    var ev = EvDa();

    ev({
      b: function(value) { equal(value, 'b', 'object (b) Callback triggered'); },
      a: function(value) { equal(value, 'a', 'object (a) Callback triggered'); },
      c: function(value) { equal(value, 'c', 'object (c) Callback triggered'); },

      // Shouldn't hit
      d: function(value) { equal(value, 'd', 'object (d) Callback triggered'); }
    });

    ev({
      a: 'a',
      b: 'b',
      c: 'c',

      // Has nothing associated with it
      e: 'e'
    });
  });

  test("register a callback, expect meta information", function(){
    var ev = EvDa();

    ev('key', function(value, meta) {
      equal(_.keys(meta).join(' '), 'meta old key done result', 'Meta information there');
      equal(meta.old, undefined, 'Old value correct');
      equal(meta.key, 'key', 'key correct');
    });

    ev('key', 'value');
  });

  test("register a callback, pass meta information", function(){
    expect(1);
    var ev = EvDa();

    ev('key', function(value, meta) {
      equal(meta.meta, 'meta', 'meta info correct');
    });

    ev('key', 'value', 'meta');
  });

  test("register a callback, pass meta object information", function(){
    expect(1);
    var ev = EvDa();

    ev('key', function(value, meta) {
      equal(meta.meta.key, 'value', 'meta info correct');
    });

    ev('key', 'value', {key: 'value'});
  });

module("Onetime callbacks on set");
  test("register a one time callback, set twice", function(){
    expect(1);
    var ev = EvDa();

    ev.once('key', function(value) {
      equal(value, 'value', 'Callback triggered');
    });

    ev('key', 'value');
    ev('key', 'value');
  });

  test("register a one time callback in the middle of many, make sure they are all called", function(){
    var ev = EvDa(), index = 0;

    for(var i = 0; i < 3; i++) {
      with({
        internal: i
      }) {
        
        ev.on('key', function() {
          equal(index, internal, "Called correctly");
          index++;
        });
      }
    }

    ev.once('key', function(value) {
      equal(value, 'value', 'one time call');
    });

    for(; i < 5; i++) {
      with({
        internal: i
      }) {
        
        ev.on('key', function() {
          equal(index, internal, "Called correctly");
          index++;
        });
      }
    }

    index = 0;
    ev('key', 'value');

    index = 0;
    ev('key', 'value');
  });

module("Tests");
  test("Set a key to a value, register a test, deny the set, and check the keys value", function() {
    var ev = EvDa();

    equal(ev.incr("key"), 1, "Key initialized to 1");
    ev.test("key", function(value, meta) {
      equal(value, 2, "Key is attempting to be set to 2");

      // deny it the pleasure.
      meta.done(false);
    });

    equal(ev.incr("key"), 1, "Key never incremented");
    equal(ev.get("key"), 1, "Key never incremented");

  });

module("Callbacks after set");
  test("Register two callbacks, check their execution order", function(){
    expect(2);

    var 
      ev = EvDa(),
      order = 0;

    ev.on('key', function(value) {
      equal(order, 0, 'Order correct');
      order++;
    });

    ev.after('key', function(value) {
      equal(order, 1, 'Order correct');
    });

    ev('key', 'value');
  });

module("Test callbacks on set");
  test("Register an on handler, stop it from happening with a test", function(){
    expect(1);
    var ev = EvDa();

    ev.test('key', function(value, meta) {
      equal(value, 'value', 'Inside the tester');
      meta.done(false);
    });

    ev.on('key', function() {
      equal(true, false, 'This should never be hit');
    });

    ev('key', 'value');
  });

  test("Register an on handler, let it happen with a test", function(){
    expect(2);
    var ev = EvDa();

    ev.test('key', function(value, meta) {
      equal(value, 'value', 'Inside the tester');
      meta.done(true);
    });

    ev.on('key', function(value) {
      equal(value, 'value', 'This should be hit');
    });

    ev('key', 'value');
  });

  test("Register an on handler, have 3 tests with the middle one failing", function(){
    expect(3);
    var ev = EvDa();

    ev.test('key', function(value, meta) {
      equal(value, 'value', 'Inside the tester');
      meta.done(true);
    });
    ev.test('key', function(value, meta) {
      equal(value, 'value', 'Inside the tester');
      meta.done(false);
    });
    ev.test('key', function(value, meta) {
      equal(value, 'value', 'Inside the tester');
      meta.done(true);
    });

    ev.on('key', function(value) {
      equal(true, false, 'This should never be hit');
    });

    ev('key', 'value');
  });

  test("Register an on handler, have 3 tests with all passing", function(){
    expect(4);
    var ev = EvDa();

    ev.test('key', function(value, meta) {
      equal(value, 'value', 'Inside the tester');
      meta.done(true);
    });
    ev.test('key', function(value, meta) {
      equal(value, 'value', 'Inside the tester');
      meta.done(true);
    });
    ev.test('key', function(value, meta) {
      equal(value, 'value', 'Inside the tester');
      meta.done(true);
    });

    ev.on('key', function(value) {
      equal(value, 'value', 'This should be hit');
    });

    ev('key', 'value');
  });

module("Running a setter");
  test("Setting a variable, checking to see if it's been set", function(){
    expect(1);
    var ev = EvDa();

    ev.set('key', 'value');
    ev.isset('key', function(value) {
      equal(value, 'value', 'Key set to value');
    });
  });
  test("Registering a setter arglist style, then Setting a variable", function(){
    expect(1);
    var ev = EvDa();

    ev.isset('key', function(value) {
      equal(value, 'value', 'Key set to value');
    });
    ev.set('key', 'value');
  });
  test("Registering a setter kv style, then Setting a variable", function(){
    expect(1);
    var ev = EvDa();

    ev.isset({
      key: function(value) {
        equal(value, 'value', 'Key set to value');
      }
    });
    ev.set('key', 'value');
  });

  test("Registering three setters kv style, then Setting a variable", function(){
    expect(3);
    var ev = EvDa();

    ev.isset({
      key0: function(value) {
        equal(value, 'value0', 'Key set to value');
      },
      key1: function(value) {
        equal(value, 'value1', 'Key set to value');
      },
      key2: function(value) {
        equal(value, 'value2', 'Key set to value');
      }
    });

    for(var i = 0; i < 3; i++) {
      ev.set('key' + i, 'value' + i);
    }
  });

module("Tracing");
  test("Tracing function execution", function() {
    expect(1);

    var ev = EvDa(); 
    ev.traceList.push(function(args) {
      equal(args[0], 'key', 'Trace called, args correct');
    });

    ev('key', 'value');
  });


module("Defining a setter");
  test("Defining a setter arglist style, then probing it with isset", function(){
    expect(2);
    var ev = EvDa(), order = 1;

    ev.setter('key', function() {
      equal(order, 2, 'Order correct - setter run');
      ev('key', 'value');
    });

    equal(order, 1, 'Order correct - setter not run yet');
    order++;
    ev.isset('key');
  });

  test("Defining a setter arglist style asynchronously, then probing it with isset", function(){
    var ev = EvDa(), key = Math.random();

    ev.setter('key', function(done) {
      setTimeout(function(){
        done(key);
      }, 10);
    });

    ev.isset('key', function(value) {
      equal(value, key, 'Asynchronously right. Woohoo');
    });
  });

  test("Defining a setter after a probing with isset", function(){
    expect(2);
    var ev = EvDa(), order = 1;

    ev.isset('key', function() {
      equal(order, 2, 'Order correct');
    });

    ev.setter('key', function() {
      equal(order, 1, 'Order correct');
      order++;
      ev('key', 'value');
    });

  });

});
</script>


